# Ansible

<!-- This package contains Ansible playbooks  -->

<!-- Ansible is used to set up a VPS and deploy the API and Scraper via Docker Compose. -->

The [`setup`](./setup.yml) playbook is used to set up an Ubuntu server and deploy the API and Scraper
with [Traefik](https://traefik.io/traefik/) as reverse proxy via Docker Compose.

## Required Roles and Collections

Required roles and collections for the playbook can be installed with:

```shell
> ansible-galaxy install -r requirements.yml
```

## Execute Playbook

To run the playbook from a world writable directory, use the
[`run_playbook_from_world_writable_directory`](./run_playbook_from_world_writable_directory.sh)
script:

```shell
> ./run_playbook_from_world_writeable_directory.sh setup.yml [--tags <tag1,tag2>]
```

otherwise it can be executed with the `ansible-playbook` command:

```shell
> ansible-playbook setup.yml
```

## Secrets

Secrets are prefixed with `vault_` and stored in an
[Ansible Vault](https://docs.ansible.com/ansible/latest/vault_guide/vault.html) in the `group_vars/all` directory.
Ansible asks for the vault password when the playbook is executed.

### Encrypt Vault

To encrypt a `vault.yml` file, run:

```shell
> ansible-vault encrypt group_vars/all/vault.yml
```

### Edit Vault

The Vault file can be edited with:

```shell
> ansible-vault edit group_vars/all/vault.yml
```

### Reset Vault Password

The Vault Password can be reset with:

```shell
> ansible-vault rekey group_vars/all/vault.yml
```

## Roles

Role variables are prefixed with the role name. All available role variables are documented in the corresponding
`/defaults/main.yml` file of the role.

### system

<!-- This role is used to configure general system settings.
It provides tasks to create a new user, set locale and timezone,
change the swap file size and disable IPv6.
 -->

<!-- This role can be used to:

- create a new user
- set the language and timezone
- change the swap file size (uses [swap role by Jeff Geerling](https://github.com/geerlingguy/ansible-role-swap))
- disable IPv6

This role can be used to configure general system settings, such as:

- creating a new user
- setting language and timezone
- changing the swap file size (uses [swap role by Jeff Geerling](https://github.com/geerlingguy/ansible-role-swap))
- disabling IPv6 -->

This role can be used to configure general system settings, such as:

- creating a new user
- setting language and timezone
- changing the swap file size (uses [swap role by Jeff Geerling](https://github.com/geerlingguy/ansible-role-swap))
- disabling IPv6

### ssh

<!-- This role is used to configure sshd with the `sshd.conf.j2` template and to generate a new ssh key pair. -->

This role can be used to configure sshd with the [`sshd.conf.j2`](./roles/ssh/templates/sshd.conf.j2)
template and to generate a new ssh key pair.

The generated key pair is located in the directory `/home/{{ ssh_localhost_user }}/.ssh/{{ inventory_hostname }}` on
the localhost (machine on that Ansible is installed).

### install_docker

This role installs the Docker engine according to the instructions in the
[documentation](https://docs.docker.com/engine/install/ubuntu/).

### limit_docker_resources

This role uses a [systemd slice unit](https://www.freedesktop.org/software/systemd/man/latest/systemd.slice.html), as suggested in
[this thread](https://unix.stackexchange.com/questions/537645/how-to-limit-docker-total-resources) on
Unix Stack Exchange, to limit the total resources that Docker is allowed to use.

<!-- More information about a systemd slice unit it can be found in the
[manpage](https://www.freedesktop.org/software/systemd/man/latest/systemd.slice.html). -->

<!-- This role uses a systemd slice unit to limit the total resources that Docker is allowed to use as suggested
in
[this thread](https://unix.stackexchange.com/questions/537645/how-to-limit-docker-total-resources) on
Unix Stack Exchange.

This role limits the total resources that Docker is allowed to use with a systemd slice unit.

This role limits the total resources that Docker is allowed to use with a systemd slice unit as read in
[this thread](https://unix.stackexchange.com/questions/537645/how-to-limit-docker-total-resources) on
Unix Stack Exchange.

This role limits the total resources that Docker is allowed to use with the systemd slice unit configuration file
`docker-resource-limit.slice` that is generated by
the [`docker-resource-limit.slice.j2`](roles/limit_docker_resources/templates/docker-resource-limit.slice.j2) template.
For more information about it, visit
[this thread](https://unix.stackexchange.com/questions/537645/how-to-limit-docker-total-resources) on
Unix Stack Exchange and take a look at the
[manpage](https://www.freedesktop.org/software/systemd/man/latest/systemd.slice.html). -->

### docker_compose

This role copies all Compose project files into the `{{ docker_compose_project_directory }}/ansible-generated`
directory on the server and starts the Compose project.

<!-- This role copies all required Compose project files to the server and starts the Compose project.
In addition, it provides the option to limit the total resources Docker is allowed to use. -->

<!-- This role is used to limit the total resources Docker is allowed to use, to copy all required files for the
Compose project to the server and run it. -->

<!-- In addition, it is used to the total resources Docker is allowed to use. -->

<!-- ### Limiting of Total Docker Resources

Since the Compose specification only allows limiting resources for a specific service,
the total resources that Docker is allowed to use is limited by the systemd slice unit configuration file
`docker-resource-limit.slice` that is generated by
the [`docker-resource-limit.slice.j2`](roles/limit_docker_resources/templates/docker-resource-limit.slice.j2) template.
For more information about it, visit
[this thread](https://unix.stackexchange.com/questions/537645/how-to-limit-docker-total-resources) on
Unix Stack Exchange and take a look at the
[manpage](https://www.freedesktop.org/software/systemd/man/latest/systemd.slice.html). -->

<!-- If specified, the total resources Docker is allowed to use are limited with the systemd slice unit configuration
file [`docker-resource-limit.slice`](./roles/docker_compose/files/docker-resource-limit.slice).

The total resources Docker is allowed to use are limited with the systemd slice unit configuration file
[`docker-resource-limit.slice`](./roles/docker_compose/files/docker-resource-limit.slice). -->

<!-- ### Copying of Compose files

All required files for the Compose project are copied into the directory
`{{ docker_compose_project_directory }}/ansible-generated` on the server. -->

#### Compose Project

<!-- This model visualizes how the API and the Scraper is deployed via Docker Compose: -->

This graphic visualizes the `compose.yml` file generated by the
[`compose.yml.j2`](./roles/docker_compose/templates/compose.yml.j2) template that is used
to deploy the API and the Scraper via Docker Compose:

<!-- This model visualizes the Compose Project defined in the -->

<img alt="Compose Project Visualization" src="compose-project-visualization.png">

<!-- The [`compose.yml.j2`](./roles/docker_compose/templates/compose.yml.j2) template file is used to create the
`compose.yml` file that is used to run the API and the Scraper via Docker.
To secure the API, the reverse proxy [Traefik](https://traefik.io/traefik/) is used. -->

<!-- To secure the API, it is sitting behind the reverse proxy [Traefik](https://traefik.io/traefik/). -->

<!-- The `compose.yml.j2` template file is used to create the `compose.yml`

The `compose.yml.j2` template file is used to create the `compose.yml` file to run the API and Scraper via Docker.

The API and the Scraper are  -->

##### Traefik Reverse Proxy

To secure the API, the reverse proxy [Traefik](https://traefik.io/traefik/) is used.
The configuration files are generated by the templates
[`traefik-static-config.yml.j2`](./roles/docker_compose/templates/traefik-static-config.yml.j2)
and [`traefik-dynamic-config.yml.j2`](./roles/docker_compose/templates/traefik-dynamic-config.yml.j2).

<!-- The Traefik configuration files are generated by the templates
[`traefik-static-config.yml.j2`](./roles/docker_compose/templates/traefik-static-config.yml.j2)
and [`traefik-dynamic-config.yml.j2`](./roles/docker_compose/templates/traefik-dynamic-config.yml.j2). -->

<!-- The Traefik configuration template can be found in the `traefik-static-config.yml.j2` and
`traefik-static-config.yml.j2` file.

The Traefik configuration is templated with the `traefik-static-config.yml.j2` and `traefik-static-config.yml.j2` file.

The Traefik configuration can be found in the `traefik-static-config.yml.j2` and the
`traefik-static-config.yml.j2` templates.

Traefik is configured with the `traefik-static-config.yml.j2` and
the `traefik-static-config.yml.j2` file

Traefik is configured with the `traefik-static-config.yml` file generated by the `traefik-static-config.yml.j2`
template and
the `traefik-static-config.yml.j2` file

The Traefik configuration files are generated by the `traefik-static-config.yml.j2` and
`traefik-static-config.yml.j2` templates. -->

###### Only Allow GET Requests

As there is currently no authentication implemented, only GET requests, except to the `/teamsOfSeason` endpoint, are
excepted and forwarded to the API.

###### Rate Limiting and Max Concurrent Connections

To prevent excessive use of the API, the
[RateLimit middleware](https://doc.traefik.io/traefik/middlewares/http/ratelimit/) of Traefik is used.
It implements the [Token Bucket Algorithm](https://www.krakend.io/docs/throttling/token-bucket/). The configuration
allows a client/IP up to 7 requests/s. If the rate is exceeded, Traefik responds with `429 Too Many Requests`.

In addition, the [InFlightReq middleware](https://doc.traefik.io/traefik/middlewares/http/inflightreq/) is used
to allow a client to only have 3 concurrent connections at a time. Here too, Traefik responds with `429 Too Many Requests`
if the rate is exceeded.

<!-- In addition, the [InFlightReq middleware](https://doc.traefik.io/traefik/middlewares/http/inflightreq/) is used
to limit the maximum concurrent connections a client can have to 3. Again, Traefik responds with 429 Too Many Requests if
the rate is exceeded. -->

<!-- Rate limiting is used to prevent excessive use of the API.

To prevent an excessive use of the API, the rate limiting is used.

To preserve resources

To mitigate the risk of an API outage due to overload. -->

<!-- It is configured via the `traefik-static-config.yml.j2` and
the `traefik-static-config.yml.j2` file to only accept GET requests except to the `/teamsOfSeasons` endpoint.
Traefik is also used to rate limit API re

It is configured via the `traefik-static-config.yml.j2` and
the `traefik-static-config.yml.j2` file to only accept GET requests to prevent data manipulation. -->

<!-- To only allow GET requests to the API
To secure the API from unwanted traffic, the reverse proxy Traefik is used.
To secure the API, the reverse proxy Traefik is used. -->

## Generate Compose Files for Development on the Local Machine

<!-- The `generate_compose_files_localhost_dev.yml` playbook generates the Compose files
for development on the local machine. -->

The [`generate_compose_files_localhost_dev`](./generate_compose_files_localhost_dev.yml) playbook can be used
to generate the Compose files for development/testing on the local machine.

The generated project can be started with this command:

```shell
> docker compose -p formula-ap1 up -d [--pull always] [api-v0 postgres traefik scraper]
```

**Notice:** Only use `--pull always` if the remote images are newer, otherwise the older ones will be used.
Services names can be provided to run only specific services.
